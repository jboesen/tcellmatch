import torch as tc
import tcellmatch.api as tm

def test_build_bilstm():
    ffn = tm.models.EstimatorFn()

    ffn.x_train = tc.randn((50, 1, 40, 26))
    ffn.x_val = tc.randn((10, 1, 40, 26))
    ffn.x_test = tc.randn((10, 1, 40, 26))
    ffn.covariates_train = tc.randn((50, 2))
    ffn.covariates_val = tc.randn((10, 2))
    ffn.covariates_test = tc.randn((10, 2))
    ffn.y_train = tc.randn((50, 51))
    ffn.y_val = tc.randn((10, 51))
    ffn.y_test = tc.randn((10, 51))

    ffn.build_bilstm(
        topology = [10, 10],
        residual_connection=True,
        aa_embedding_dim=0,
        optimizer='adam',
        lr=0.001,
        loss='pois' if USE_BIND_COUNTS else 'wcbe',
        label_smoothing=0,
        use_covariates=False,
        one_hot_y=not USE_BIND_COUNTS
    )

    os.makedirs("save_test", exist_ok=True)
    # save_yhat means save predictions
    ffn.save_model_full(f'save_test', save_yhat=True, save_train_data=True)
    before_eval = ffn.evaluate(test_only=True)
    ffn2 = tm.models.EstimatorFn()
    ffn2.load_model(fn=f'{indir}saved_model')
    ffn2.evaluate(test_only=True)
    after_eval = ffn2.evaluate(test_only=True)

    assert after_eval == before_eval

